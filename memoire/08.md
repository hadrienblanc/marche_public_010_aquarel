# 8. Haute disponibilité et contraintes associées

## Introduction

La haute disponibilité est un élément structurant de l'architecture AQUAREEL, directement lié à la criticité de l'application dans le cadre des missions de sécurité civile. La prévision des crues et la surveillance hydrométrique tolèrent difficilement toute interruption de service. Notre approche de la TMA intègre pleinement cette exigence : toute intervention, qu'il s'agisse de maintenance évolutive ou corrective, vise à préserver le fonctionnement de l'architecture de haute disponibilité et à respecter les contraintes spécifiques qu'elle impose.

Ce chapitre détaille notre compréhension de l'architecture multi-site, les contraintes techniques que nous appliquerons systématiquement, et les procédures que nous mettrons en œuvre pour contribuer à la continuité de service.

## 8.1 Compréhension de l'architecture de haute disponibilité

### 8.1.1 Principe général de redondance

L'architecture de haute disponibilité AQUAREEL repose sur une redondance à chaud entre sites géographiquement distincts :

- **1 site actif** : site principal assurant l'ensemble des fonctionnalités de concentration (collecte, exploitation, diffusion)
- **1 à plusieurs sites passifs** : sites de secours en lecture seule, maintenus à jour en temps réel
- **1 site de surveillance** : site dédié à la supervision du bon fonctionnement de l'ensemble

Cette architecture vise à assurer la continuité de service en cas de panne matérielle, de désastre naturel ou d'indisponibilité d'un site. Les sites passifs sont conçus pour pouvoir reprendre les fonctionnalités du site actif.

### 8.1.2 Mécanisme de réplication SQL Server

Le cœur de la haute disponibilité repose sur la **réplication transactionnelle SQL Server**, fonctionnalité native du SGBD :

**Fonctionnement de la réplication :**
- Capture instantanée initiale des objets et données de la base de publication (site actif)
- Transmission en temps quasi-réel des modifications vers les abonnés (sites passifs)
- Synchronisation continue des données entre le nœud actif et les nœuds passifs

**Caractéristiques techniques :**
- Réplication au niveau de la base de données de production
- Utilisation d'une publication de réplication configurée par scripts prédéfinis
- Surveillance du fonctionnement de la réplication depuis le client Windows
- Possibilité de réinitialisation manuelle des abonnés en cas de désynchronisation

### 8.1.3 Modes de bascule et de secours

La haute disponibilité d'AQUAREEL combine deux niveaux de secours :

**Secours automatique (sans bascule) :**
- **Collecte radio** : les données radio sont reçues simultanément par le site passif et insérées dans la base du site actif via réplication
- **Collecte IP** : les stations envoient en secours leurs mesures vers le frontal IP du site passif qui les insère dans la base du site actif
- **Collecte LoRaWAN** : le site passif réalise les collectes en secours depuis son propre service
- **Échanges** : réalisation des imports/exports en secours depuis le site passif

Ce mode de secours automatique permet de maintenir la collecte et la diffusion même en cas de défaillance partielle du site actif, sans intervention humaine.

**Basculement manuel complet :**
- Activation complète du site passif par l'opérateur via le gestionnaire de bascule
- Transfert de l'ensemble des tâches de concentration vers le site de secours
- Désactivation des tâches du site actif et suppression de la réplication
- Inversion des rôles actif/passif

Ce basculement est déclenché manuellement par un opérateur d'astreinte suite à une alarme de supervision, et permet de gérer les pannes graves ou les indisponibilités prolongées du site actif.

### 8.1.4 Système de supervision multi-site

La surveillance de la haute disponibilité repose sur un système de supervision croisée entre trois sites :

**Architecture de supervision :**
- Services de supervision présents sur les 2 sites de concentration (actif et passif)
- Service de supervision sur le site de surveillance
- Vérification croisée selon le principe du quorum (similaire aux clusters système)

**Mécanismes de surveillance :**
- Surveillance par trames TCP sur ports réseau
- Détection d'indisponibilité d'un site (actif, passif, surveillance)
- Détection d'indisponibilité d'un service (SGBD, service d'alarme, service de collecte, service d'import/export)
- Détection d'indisponibilité du serveur d'appel vocal

**Gestion des alarmes :**
- Émission d'alarmes téléphoniques vers l'opérateur d'astreinte en cas de dysfonctionnement
- Traçabilité des événements de supervision dans le journal de bord
- Remontée des anomalies permettant la décision de basculement

### 8.1.5 Architecture réseau et communication inter-sites

La robustesse de la haute disponibilité repose également sur la redondance des communications :

**Double chemin réseau :**
- Réseau privé de collecte
- Réseau ministériel (RIE)

**Routage dynamique :**
- Mise en œuvre sur les pare-feux
- Permet aux 2 instances de disposer en permanence de 2 réseaux pour communiquer
- Pallier l'indisponibilité de l'un des réseaux

Cette double voie de communication contribue à maintenir la réplication et la supervision en fonctionnement même en cas d'indisponibilité d'un des réseaux.

## 8.2 Contraintes techniques liées à la haute disponibilité

### 8.2.1 Contrainte majeure : compatibilité avec la réplication SQL Server

**Principe fondamental :**

Toute évolution du modèle de données ou modification des traitements en base doit être compatible avec le mécanisme de réplication transactionnelle SQL Server. Cette contrainte est structurante et doit être intégrée dès la conception, la réalisation et la recette.

**Impacts sur les développements :**

Nous nous engageons à respecter systématiquement les règles suivantes lors de toute intervention de maintenance évolutive :

**Évolution du modèle de données :**
- Analyse préalable de l'impact sur la publication de réplication
- Validation explicite de la compatibilité avec la réplication avant application
- Utilisation exclusive de types de données et structures compatibles avec la réplication transactionnelle
- Éviter les opérations non supportées par la réplication (certains types ALTER TABLE, certaines contraintes)
- Test systématique de la réplication après modification du schéma

**Développements en base de données :**
- Privilégier les procédures stockées et vues pour toutes les opérations DML (INSERT, UPDATE, DELETE)
- Éviter les curseurs et fonctions scalaires qui peuvent impacter la réplication
- Utiliser les triggers avec précaution (risque de conflit de réplication)
- Respecter les règles de publication/souscription lors de l'ajout de nouvelles tables

**Scripts de mise à jour :**
- Fournir des scripts de mise à jour compatibles réplication
- Tester les scripts sur une architecture HD de test avant livraison
- Documenter explicitement l'impact sur la réplication dans les dossiers de conception

**Checklist de compatibilité réplication (avant livraison)**
- identification des objets impactés (tables/articles, triggers, jobs, procédures) et de la stratégie de mise à jour ;
- validation du séquencement (schéma / code / jobs) et des opérations sensibles en contexte réplication ;
- exécution des scripts sur la plateforme de test HD du titulaire ;
- vérification du bon fonctionnement des agents et de l'absence d'erreurs de réplication (monitoring) ;
- vérification de la synchronisation et de la latence, avec seuils d'alerte définis avec la maîtrise d'ouvrage ;
- procédure de rollback définie et documentée (conditions de déclenchement, étapes, impacts).

### 8.2.2 Contrainte opérationnelle : tests de non-régression sur la haute disponibilité

**Obligation de test systématique :**

Chaque livraison (évolutive ou corrective) doit faire l'objet de tests spécifiques de non-régression sur la haute disponibilité, en sus des tests fonctionnels habituels.

**Tests à réaliser :**

Nous intégrerons dans nos cahiers de recette les vérifications suivantes :

**Tests de réplication :**
- Vérification du bon fonctionnement de la réplication après installation de la mise à jour
- Contrôle de la synchronisation des données entre site actif et site passif
- Test de réinitialisation d'un abonné
- Vérification de l'absence d'erreurs dans les logs de réplication

**Tests de secours automatique :**
- Vérification de la prise en charge automatique des tâches en secours par le site passif
- Test de collecte IP en secours (mesures reçues par le frontal IP passif)
- Test de collecte LoRaWAN en secours
- Test d'exports en secours

**Tests de basculement manuel :**
- Simulation de basculement vers le site passif via le gestionnaire de bascule
- Vérification de la bonne reprise des tâches de concentration par le site nouvellement actif
- Vérification de l'inversion des rôles actif/passif
- Test de basculement retour vers le site nominal

**Tests de supervision :**
- Vérification du bon fonctionnement de la supervision inter-sites
- Test de détection d'indisponibilité d'un service
- Vérification de la remontée d'alarmes

Ces tests seront réalisés sur la plateforme de test HD du titulaire (2 sites de concentration + 1 site de surveillance) avant toute livraison au maître d'ouvrage.

### 8.2.3 Contrainte de déploiement : coordination multi-sites

**Synchronisation des mises à jour :**

Le déploiement d'une mise à jour dans un contexte de haute disponibilité nécessite une coordination précise entre les différents sites.

**Procédure de déploiement :**

Nous appliquerons systématiquement les étapes suivantes :

1. **Préparation du déploiement :**
   - Vérification de la compatibilité de la mise à jour avec la réplication
   - Préparation des scripts de mise à jour pour chaque site
   - Planification de la fenêtre de déploiement en accord avec le service utilisateur

2. **Mise à jour du site actif :**
   - Installation sur le site actif en premier
   - Vérification du bon fonctionnement
   - Surveillance de la réplication

3. **Mise à jour du/des site(s) passif(s) :**
   - Installation sur le(s) site(s) passif(s)
   - Vérification de la synchronisation
   - Test du secours automatique

4. **Mise à jour du site de surveillance :**
   - Installation du service de supervision si impacté
   - Vérification de la supervision inter-sites

5. **Tests de validation globale :**
   - Réalisation des tests de non-régression HD
   - Validation du bon fonctionnement d'ensemble

**Critères Go / No‑Go et rollback**
- Le passage en production est conditionné par la réussite de la campagne de tests (dont non‑régression HD) et un état sain de la réplication (absence d'erreurs, synchronisation cohérente).
- En cas d'écarts significatifs (erreurs de réplication, dérive de latence, alarme critique), le titulaire propose un No‑Go et déclenche, en accord avec la maîtrise d'ouvrage, la procédure de rollback prévue.

**Gestion des incompatibilités temporaires :**

En cas d'incompatibilité temporaire entre versions (nouvelle colonne, nouvelle table) :
- Documentation précise de la procédure de montée de version
- Séquencement strict des opérations (schéma avant code, ou l'inverse selon le cas)
- Possibilité de suspension temporaire de la réplication si nécessaire (cas exceptionnel, documenté, validé par la MOA)

### 8.2.4 Contrainte de données : volumétrie et performance de la réplication

**Impact de la volumétrie :**

L'application AQUAREEL gère des volumes de données importants (1 mesure par capteur toutes les 5 minutes pour 250 stations possédant chacune 3 capteurs, extensible). Cette volumétrie a un impact direct sur la réplication.

**Exigences de performance :**

Nous veillons à :

- **Optimiser les requêtes** : éviter les requêtes générant des mises à jour massives qui satureraient la réplication
- **Privilégier les traitements par lot** : regrouper les opérations pour limiter les transactions individuelles
- **Surveiller la latence de réplication** : vérifier que les sites passifs restent synchronisés en temps quasi-réel
- **Tester les performances** : mesurer l'impact sur la réplication lors des tests de charge

**Cas spécifiques :**

Certaines opérations nécessitent une attention particulière :
- Migrations de données historiques : planification en dehors des heures de collecte intensive
- Retraitements massifs : évaluation de l'impact sur la réplication, découpage en lots si nécessaire
- Purges et archivages : respect des procédures existantes compatibles réplication

### 8.2.5 Stratégie d'évolution compatible (schéma / code / déploiement)

Afin de réduire les risques en production et en haute disponibilité, le titulaire privilégie, lorsque c'est possible, des évolutions :
- **additives** (ajout de colonnes/tables/objets plutôt que modifications destructives) ;
- **séquencées** (schéma puis code, ou l'inverse selon le cas, avec justification) ;
- **réversibles** (rollback documenté) ;
- **observables** (points de surveillance post‑déploiement : réplication, logs, alarmes, métriques).

Ces principes sont formalisés dans les dossiers de conception et vérifiés lors de la campagne de tests de non‑régression (dont HD) avant livraison.

## 8.3 Prestations spécifiques liées à la haute disponibilité

### 8.3.1 Installation du fonctionnement d'ensemble (prestation d'exploitation)

**Nature de la prestation :**

L'installation du fonctionnement d'ensemble consiste à mettre en place les fonctionnalités de haute disponibilité entre 2 sites de concentration préalablement installés. Cette prestation est commandée par les services utilisateurs sur la base du BPU.

**Prérequis :**

- 2 instances AQUAREEL installées et configurées (site actif et site passif)
- 1 site de surveillance disponible
- Réalisation d'un audit préalable (recommandé)
- Connectivité réseau entre les sites (réseau de collecte et réseau ministériel)

**Étapes de mise en œuvre :**

Nous réaliserons les opérations suivantes, à distance, selon la procédure fournie par le maître d'ouvrage :

**1. Configuration du cluster HD :**
- Déclaration dans la base du site actif des sites constituant le cluster en haute disponibilité
- Identification et paramétrage du site principal
- Récupération dans le site actif du paramétrage des périphériques du site passif

**2. Paramétrage et mise en œuvre de la réplication :**
- Exécution des scripts prédéfinis de configuration de la réplication
- Configuration de la publication sur le site actif
- Configuration de la souscription sur le(s) site(s) passif(s)
- Lancement de la capture instantanée initiale
- Vérification de la synchronisation

**3. Installation et paramétrage du gestionnaire de bascule :**
- Déploiement de l'exécutable Windows du gestionnaire de bascule
- Configuration du fichier de configuration (adresses IP des serveurs BDD des sites de concentration)
- Tests de fonctionnement

**4. Installation et paramétrage de la supervision entre les sites :**
- Installation du service d'alarme sur le site de surveillance (activation du module de supervision uniquement)
- Configuration des 3 modules de supervision pour la supervision inter-sites
- Déclaration des sites à surveiller dans les fichiers de configuration XML
- Vérification de la surveillance croisée

**5. Tests et validation du fonctionnement d'ensemble :**
- Test de prise en charge automatique des tâches en secours par chaque site passif
- Réalisation de tests de bascule (basculement vers site de secours puis retour)
- Vérification de la bonne reprise des tâches de concentration
- Vérification de l'inversion des rôles actif/passif
- Validation avec le service utilisateur

**Durée et délais :**
- Durée de l'installation : 2 jours
- Délai de réalisation : 4 semaines après audit (si réalisé) + 4 semaines après bon de commande (CCTP)
- Validation : 1 mois à compter de la mise en service

**Livrables :**
- Rapport d'installation détaillé
- Documentation de la configuration spécifique du site
- Résultats des tests de validation

### 8.3.2 Audits périodiques avec volet haute disponibilité

**Vérifications spécifiques HD dans les audits :**

Les audits périodiques que nous réaliserons (1 à 2 fois par an selon la taille de l'instance) comporteront un volet spécifique pour les architectures en haute disponibilité :

**Vérifications de configuration :**
- État de la réplication (latence, erreurs éventuelles, dernière capture instantanée)
- Configuration des publications et souscriptions
- Paramétrage du gestionnaire de bascule
- Configuration de la supervision inter-sites

**Vérifications de fonctionnement :**
- Prise en charge automatique des tâches en secours par le site passif en cas d'échec du site actif
- Vérification après bascules réalisées par le service utilisateur :
  - Bonne reprise des tâches de concentration par le site nouvellement actif
  - Bonne inversion des rôles actif/passif suite à bascule vers le site de secours
  - Bonne inversion des rôles actif/passif suite à bascule retour vers le site nominal

**Tests de basculement :**
- Test de basculement complet en collaboration avec le service utilisateur
- Mesure des temps de bascule
- Vérification de l'absence de perte de données
- Vérification de la reprise de la réplication après retour à la normale

**Durée des tests HD :**
- Tests de fonctionnement d'ensemble de la haute disponibilité : 1/2 journée

### 8.3.3 Maintenance corrective et interventions urgentes en contexte HD

**Particularités des interventions en HD :**

Lors d'interventions correctives ou urgentes sur des instances en haute disponibilité, nous appliquerons les précautions suivantes :

**Diagnostic :**
- Identifier si l'anomalie affecte uniquement le site actif ou également les sites passifs
- Analyser l'impact éventuel de la réplication sur l'anomalie
- Vérifier l'état de la réplication (risque de réplication d'une donnée corrompue)

**Correction :**
- Appliquer la correction sur le site actif en priorité
- Vérifier que la correction se réplique correctement sur les sites passifs
- Si nécessaire, appliquer manuellement la correction sur les sites passifs
- Dans certains cas (corruption de données), suspension temporaire de la réplication pour corriger les sites indépendamment, puis resynchronisation

**Validation :**
- Tests de non-régression sur le site actif
- Vérification de la réplication
- Tests de secours automatique
- Test de basculement si l'anomalie était critique

## 8.4 Plateforme de test en haute disponibilité

### 8.4.1 Configuration de la plateforme HD du titulaire

Dans le cadre de la phase d'initialisation, nous mettrons en place une plateforme de test reproduisant un fonctionnement d'ensemble d'AQUAREEL dans sa configuration HD :

**Architecture de la plateforme :**
- 2 sites de concentration (actif et passif)
- 1 site de surveillance
- Mise en œuvre de la collecte des stations de test (stations LNS et AQUACJ fournies par la MOA)

**Environnement virtualisé :**
- Utilisation de machines virtuelles pour limiter le nombre de serveurs physiques
- Respect de l'architecture réseau (séparation zone de collecte / zone métier)
- Configuration de la réplication SQL Server entre les 2 sites de concentration
- Configuration de la supervision inter-sites

Cette plateforme sera notre outil principal pour :
- Valider toutes les évolutions avant livraison
- Tester les corrections en contexte HD
- Reproduire les anomalies remontées par les utilisateurs
- Tester les montées de version
- Valider les procédures de déploiement

### 8.4.2 Utilisation de la plateforme de Privas

Pour les évolutions et tests spécifiques à la collecte radio, nous utiliserons la plateforme AQUAREEL de test disponible à Privas (SPC GD), accessible à distance. Cette plateforme sera utilisée pour :

- Tests de validation spécifiques à la radio avant livraison au maître d'ouvrage
- Tests de validation plus généraux utilisant la radio
- Validation en environnement réel radio

## 8.5 Documentation et traçabilité

### 8.5.1 Documentation technique spécifique HD

Nous maintiendrons à jour la documentation technique concernant la haute disponibilité :

**Manuel d'exploitation :**
- Procédures de déploiement en contexte HD
- Procédures de surveillance de la réplication
- Procédures de basculement et de retour à la normale
- Procédures de diagnostic des pannes en HD

**Manuel d'installation :**
- Procédure d'installation du fonctionnement d'ensemble
- Configuration de la réplication
- Configuration du gestionnaire de bascule
- Configuration de la supervision inter-sites

**Modèle de données :**
- Éléments spécifiques à la gestion de la HD (tables de configuration des sites, supervision)
- Configuration de la publication de réplication

### 8.5.2 Traçabilité des interventions

Pour chaque intervention ayant un impact sur la haute disponibilité, nous documenterons :

**Dans les dossiers de conception :**
- Analyse d'impact sur la réplication
- Stratégie de déploiement multi-sites
- Tests de non-régression HD prévus

**Dans les rapports d'installation/livraison :**
- Résultats des tests de non-régression HD
- Vérification de la réplication après mise à jour
- Résultats des tests de basculement

**Dans les rapports d'audit :**
- État de santé de la réplication
- Historique des basculements depuis le dernier audit
- Recommandations pour optimiser la HD

## 8.6 Formation et transfert de compétence

### 8.6.1 Montée en compétence du titulaire

Le titulaire dispose d'une expertise solide en SQL Server et en réplication transactionnelle. Néanmoins, nous nous engageons à :

- Approfondir notre connaissance de la configuration spécifique HD d'AQUAREEL lors de la phase d'initialisation
- Documenter les bonnes pratiques et pièges à éviter
- Capitaliser sur les retours d'expérience des interventions
- Maintenir à jour un référentiel de connaissances HD interne

### 8.6.2 Transfert vers le maître d'ouvrage

Dans le cadre de la tranche optionnelle de réversibilité (période de transition), le transfert de compétence inclura spécifiquement :

- Présentation détaillée de l'architecture HD et de ses mécanismes
- Formation à l'administration de la réplication SQL Server
- Formation à l'utilisation du gestionnaire de bascule
- Formation à la supervision inter-sites
- Démonstration des procédures de diagnostic et de résolution de problèmes en contexte HD
- Assistance à l'installation d'une plateforme de test HD fonctionnelle

## Conclusion

La haute disponibilité est au cœur de la criticité d'AQUAREEL. Nous avons pleinement intégré cette dimension dans notre approche de la TMA. Nos engagements sont clairs :

- **Compatibilité systématique** : toute évolution sera compatible avec la réplication SQL Server
- **Tests rigoureux** : tests de non-régression HD systématiques avant toute livraison
- **Déploiement coordonné** : procédures de déploiement multi-sites maîtrisées et documentées
- **Expertise technique** : maîtrise de SQL Server et de la réplication transactionnelle
- **Traçabilité** : documentation complète de tous les aspects liés à la HD

Notre objectif est de préserver la haute disponibilité d'AQUAREEL lors de nos interventions de maintenance, et de contribuer à la continuité de service attendue pour les missions de prévision des crues et de sécurité civile.
