# 2. Description synthétique de l'architecture existante AQUAREEL

> **Lecture jury — à retenir**
> - Objectif : démontrer la compréhension de l'architecture AQUAREEL (SQL Server central, services, clients, HD, volumétrie).
> - Risques évités : régressions liées au SGBD/réplication, déploiements incompatibles HD, dérives de performance.
> - Réponse du titulaire : interventions incrémentales, analyse d'impact SQL/HD, tests de non‑régression base + applicatif.
> - Preuves : Chapitre 8 (HD), Chapitre 9 (tests), Annexe A.1 (note de livraison) / A.2 (rapport de tests).

## 2.1 Vue d'ensemble de l'architecture AQUAREEL

Le concentrateur AQUAREEL constitue l'outil national unique de collecte du réseau Vigicrues, déployé dans l'ensemble des Services de Prévisions des Crues (SPC) et des Cellules de Veille Hydrologique (CVH). Le titulaire a pris connaissance de l'architecture existante et en a identifié les caractéristiques structurantes qui contribuent à assurer la fiabilité et la continuité de service attendues pour une application de sécurité civile.

L'application assure quatre fonctions essentielles :

- **Collecte et stockage** des données hydrométriques via différents médias (radio, RTC/GSM, IP, LoRaWAN)
- **Exploitation et traitement** des données affinées pour la prévision des crues
- **Suivi du fonctionnement** par journalisation, supervision et système d'alarmes
- **Diffusion** des données vers les systèmes aval (base nationale PHyC, sites internet, applications locales)

Cette architecture, éprouvée depuis de nombreuses années dans le cadre des missions de prévision des crues, repose sur des principes techniques solides que nous nous engageons à préserver et à maintenir tout au long de notre intervention.

## 2.2 Architecture technique unitaire

### 2.2.1 Principes architecturaux fondamentaux

AQUAREEL repose sur une **architecture orientée service (SOA)** centrée sur le système de gestion de base de données (SGBD). Ce choix architectural structurant place le SGBD SQL Server au cœur du système, assurant ainsi :

- La centralisation de la logique métier majoritairement implémentée en base de données
- La simplification des développements par l'utilisation des fonctions natives du SGBD
- La limitation des interactions entre processus externes
- La cohérence et l'intégrité des données hydrométriques critiques

Cette approche éprouvée constitue l'épine dorsale du système et sera rigoureusement respectée dans le cadre de nos interventions de maintenance.

Le titulaire capitalise sur une expérience de plus de vingt années sur SQL Server pour intervenir au plus près du cœur du système : diagnostic de performances (plans d'exécution, indexation), analyse de la réplication transactionnelle, optimisation des procédures stockées et des triggers. Cette expertise est particulièrement adaptée à une architecture où l'essentiel de la logique métier est implémenté en base de données.

### 2.2.2 Composants applicatifs et répartition fonctionnelle

L'architecture unitaire d'AQUAREEL se compose des éléments suivants :

**Services Windows dédiés :**

- **Service de collecte** : gestion de l'acquisition des données via médias radio et RTC/GSM
- **Service d'échange** : gestion des imports et exports de fichiers de mesures et d'images
- **Service d'alarme** : transmission téléphonique, par mail et supervision de l'application
- **Service internet** : envoi de SMS et interrogation du serveur LoRaWAN
- **Serveur web (IIS)** : frontal de collecte IP pour la réception des flux XML des stations

**Base de données SQL Server :**

Le SGBD assure les fonctionnalités cœur de métier :

- Exploitations hydrologiques et événementielles
- Planification des tâches de concentration
- Calculs des indicateurs hydrologiques (débits, cumuls pluviométriques, gradients)
- Affinage et validation des données collectées
- Gestion des alarmes hydrologiques

**Trois instances de bases de données corrélées :**

1. **Base tampon** : stockage temporaire des mesures brutes issues des stations sur une période glissante
2. **Base de production** : données affinées et exploitables, paramétrage applicatif, journal d'événements, sur une antériorité paramétrable
3. **Base archive** : conservation historique au-delà de l'antériorité de la base de production (fonction appelée à être supprimée)

Cette séparation fonctionnelle assure la dissociation entre le processus d'acquisition (base tampon) et celui de mise en production et conservation (base de production), assurant ainsi la traçabilité et la fiabilité des données exploitées.

### 2.2.3 Environnement technique et logiciel

La plateforme technique repose sur l'écosystème Microsoft :

**Serveurs :**
- Windows Server 2016 Standard Edition 64 bits
- SQL Server 2016 SP2 Standard Edition

**Postes clients :**
- Windows 10 ou Windows 11
- Framework .NET 4.7.2 et .NET 8

**Infrastructure applicative :**
- Serveur web IIS 10
- Services Windows développés en C#
- Développements base en Transact-SQL

Cette homogénéité technologique facilite l'administration, le déploiement et assure la compatibilité avec l'environnement des services utilisateurs.

### 2.2.4 Configuration matérielle type

La configuration matérielle standard est dimensionnée pour assurer les performances nécessaires au traitement des volumes de données hydrométriques :

**Serveur principal (zone de collecte) :**
- Processeurs : 2 processeurs octo-cœur de 1,8 GHz
- Mémoire RAM : 16 Go
- Stockage : 600 Go en RAID 1 ou RAID 10 (disques 15 000 tr/min)
- Hébergement du SGBD, des services de collecte et d'alarme, du frontal IP

**Serveur d'échange (zone métier) :**
- Configuration type PC Windows 11
- Hébergement des services Internet et Échange

Cette architecture matérielle optimisée sera préservée tout au long du marché. Nous nous engageons à optimiser nos développements pour contribuer au maintien des performances dans cette configuration.

## 2.3 Applications clientes

### 2.3.1 Client Windows (client lourd)

L'application cliente Windows constitue historiquement l'interface principale d'administration et d'exploitation d'AQUAREEL. Elle permet d'assurer :

- L'exploitation complète des mesures issues des stations hydrologiques
- La surveillance exhaustive du fonctionnement du système
- Le paramétrage détaillé de l'application et des référentiels

Le client Windows se connecte à la base de production et peut également accéder à la base archive via des vues partitionnées, permettant l'exploitation de l'intégralité de l'historique des données.

### 2.3.2 Client léger (application web)

Le client léger, de type application web, offre les fonctionnalités essentielles de consultation et de paramétrage :

- Exploitation des mesures issues des stations hydrologiques
- Surveillance du fonctionnement du système
- Lancement de commandes vers les stations
- Paramétrage du référentiel station et des tâches de concentration (collectes, échanges, alarmes)

Le client léger se connecte exclusivement à la base de production et constitue l'évolution cible de l'application. **L'objectif identifié par la maîtrise d'ouvrage est d'abandonner progressivement le client Windows au profit du client léger**, dans une démarche de simplification du déploiement et de maintenance.

Le titulaire accompagnera cette transition en veillant à la continuité de service et à la préservation de toutes les fonctionnalités métier essentielles.

## 2.4 Fonctionnalités de collecte des données

### 2.4.1 Collecte radio SCORPION 2

La collecte radio s'appuie sur le réseau SCORPION 2 développé par la société COMATIS, utilisant le protocole propriétaire SMI. L'équipement radio est relié au concentrateur par liaison RS232, permettant la collecte simultanée en mode automatique et manuel.

### 2.4.2 Collecte téléphonique (RTC/GSM)

Les stations équipées d'abonnements téléphoniques sont collectées via des pools de modems. La communication utilise le protocole PLQ (propriété du Ministère de la Transition Écologique), basé sur la norme européenne I-ETS 300 230.

### 2.4.3 Collecte IP

La majorité des stations est connectée au réseau privé de collecte via des connexions IP sécurisées (GPRS/3G/4G/ADSL/fibre). La station est à l'initiative de la transmission (mode push) :

- Envoi périodique de flux XML (mesures, alarmes techniques, états de la station)
- Transmission d'images (photos et vidéos) acquises par caméra
- Récupération de demandes du frontal IP (modifications de paramètres, collectes de rattrapage, rendez-vous de maintenance, mises à jour logicielles)

### 2.4.4 Collecte LoRaWAN

Les stations équipées de modules LoRaWAN déposent leurs trames de mesures sur un serveur opérateur. AQUAREEL récupère périodiquement ces trames via l'API HTTP du serveur, puis décode les payloads selon les formats spécifiques aux modules LoRaWAN hydrométriques.

### 2.4.5 Import de fichiers

AQUAREEL peut importer automatiquement ou manuellement des fichiers de mesures et d'images présents sur des répertoires partagés CIFS ou des serveurs FTP, selon des formats prédéfinis.

## 2.5 Exploitation et traitement des données

### 2.5.1 Affinage et stockage des données

Les données brutes collectées sont affinées (validation, détection de valeurs aberrantes) avant stockage dans la base de production. Les données brutes sont conservées temporairement dans la base tampon pour traçabilité et rejeu éventuel.

### 2.5.2 Calculs hydrologiques

AQUAREEL calcule à la volée les indicateurs hydrologiques complémentaires :

- **Débits instantanés** : calculés à partir des hauteurs d'eau mesurées via les courbes de tarage (relations hauteur-débit spécifiques à chaque site)
- **Cumuls pluviométriques** : agrégation des mesures pluviométriques élémentaires
- **Gradients de montée des eaux** : évolution entre deux valeurs de hauteur consécutives

Ces données calculées ne sont pas stockées en base mais générées dynamiquement lors de l'exploitation, optimisant ainsi la volumétrie de stockage.

### 2.5.3 Système d'alarmes hydrologiques et techniques

L'application génère automatiquement des alarmes :

- **Alarmes hydrologiques** : dépassement de seuils en valeur ou en gradient
- **Alarmes techniques** : dysfonctionnements de collecte, indisponibilité de stations, échecs d'export

Les alarmes sont transmises aux utilisateurs par téléphone (via opérateur externe), mail ou SMS.

### 2.5.4 Journal de bord et traçabilité

Le journal de bord centralise l'ensemble des événements :

- Opérations de collecte (déclenchements, réalisations, échecs, rattrapages)
- Réalisation des exports et imports
- Affinage des données (détection de valeurs aberrantes et invalides)
- Alarmes (ouverture, transmission, acquittement, fermeture)
- Connexions et déconnexions des utilisateurs

Les événements sont typés et gradués par ordre d'importance, facilitant leur exploitation et la détection rapide d'anomalies.

## 2.6 Optimisation du stockage et performance

### 2.6.1 Volumétrie des données

Les bases de données AQUAREEL gèrent des volumes conséquents :

- **Fréquence de mesure** : 1 mesure par capteur toutes les 5 minutes
- **Parc stations** : environ 250 stations possédant chacune 3 capteurs (nombre évolutif)
- **Volume annuel** : ~15 Go/an pour 200 stations
- **Concentration des données** : l'essentiel du volume tient sur 6 tables principales

### 2.6.2 Principes d'optimisation du stockage

Pour maîtriser cette volumétrie tout en préservant les performances, AQUAREEL met en œuvre plusieurs stratégies éprouvées :

**Non-stockage des données calculées :**
Seules les mesures brutes issues des capteurs sont stockées. Les débits, cumuls pluviométriques et gradients sont calculés à la volée lors de l'exploitation, réduisant significativement l'espace disque nécessaire.

**Non-stockage des valeurs pluviométriques à zéro :**
La très grande majorité des mesures pluviométriques étant égale à zéro (plus de 98% dans certaines régions), AQUAREEL ne stocke que les valeurs supérieures à zéro et les valeurs manquantes. Les valeurs nulles sont reconstituées dynamiquement lors de l'exploitation.

**Purge systématique des informations non significatives :**
Les données brutes de collecte, fichiers temporaires et événements de faible importance sont purgés automatiquement au-delà d'une antériorité paramétrable, contribuant à la stabilité des performances.

**Archivage optionnel :**
Les données de production dépassant l'antériorité de conservation peuvent être migrées vers la base archive (fonctionnalité optionnelle amenée à disparaître).

Ces mécanismes assurent la pérennité des performances applicatives malgré l'accumulation continue de données hydrométriques.

Pour sécuriser les évolutions dans ce contexte de volumétrie importante, nous mettons en place des tests de non-régression centrés sur la base de données : jeux de données de référence réalistes, scripts ciblant les procédures stockées et triggers critiques, scénarios automatisés couvrant la chaîne collecte → affinage → export. Ces tests sont rejoués systématiquement avant chaque livraison afin de vérifier la stabilité des temps de réponse et la compatibilité avec les mécanismes de réplication et d'archivage.

## 2.7 Architecture multi-sites et haute disponibilité

### 2.7.1 Principes de la haute disponibilité

Compte tenu du caractère critique d'AQUAREEL pour les missions de sécurité civile (prévision des crues et inondations), la **haute disponibilité** constitue un axe majeur de l'architecture.

La configuration HD (Haute Disponibilité), recommandée par la maîtrise d'ouvrage auprès des services utilisateurs, repose sur :

- **Déploiement sur trois nœuds géographiquement distincts** :
  - 1 site actif assurant l'ensemble des tâches de concentration
  - 1 à plusieurs sites passifs en lecture seule, prêts à reprendre les fonctions du site actif
  - 1 site de surveillance pour affiner les diagnostics de supervision

- **Réplication transactionnelle des bases de données** :
  - Mise à jour en temps réel de la base du site passif depuis le site actif
  - Utilisation de la réplication transactionnelle native de SQL Server
  - Transmission quasi temps réel des changements de données

Cette architecture vise à assurer la continuité de service en cas de défaillance matérielle, incident réseau ou désastre sur le site actif.

### 2.7.2 Mécanismes de résilience automatique

L'architecture HD met en œuvre des mécanismes de secours automatique pour les fonctions critiques :

**Résilience de la collecte radio :**
Le service de collecte radio du site passif alimente de manière redondante la base tampon du site actif, palliant ainsi toute indisponibilité de collecte radio sur le site actif.

**Résilience de la collecte IP :**
Les stations envoient leurs flux XML en mode normal/secours : en cas d'échec d'envoi sur le frontal IP principal, la station bascule automatiquement vers le frontal IP du site passif. Chaque frontal IP insère les flux reçus dans le site actif en signant son insertion pour traçabilité.

**Résilience de la collecte LoRaWAN :**
En cas d'échec du service Internet du site actif, le site passif prend automatiquement en charge la collecte des trames LoRaWAN depuis le serveur opérateur.

**Résilience des échanges (imports/exports) :**
En cas d'échec des échanges sur le site actif (coupure réseau RIE ou défaillance du service), les imports et exports sont automatiquement pris en charge par le service d'échange du site passif.

**Résilience de la transmission d'alarmes :**
Le service d'alarme du site passif assure en secours automatique la transmission téléphonique des alarmes si le serveur d'appel vocal du site actif est indisponible.

### 2.7.3 Basculement manuel et gestionnaire de bascule

En cas de défaillance majeure du site actif, l'activation complète du site passif est réalisée **manuellement** par l'utilisateur via le **gestionnaire de bascule**, application cliente dédiée.

Le gestionnaire de bascule effectue les opérations suivantes :

- Désactivation des tâches de concentration sur le site actif (collectes, échanges)
- Activation des tâches de concentration sur le site passif
- Suppression de la réplication depuis le site actif
- Inversion des rôles actif/passif

Cette approche de basculement manuel permet à l'opérateur d'astreinte de garder la maîtrise de la décision de bascule, tout en bénéficiant de l'automatisation technique de l'opération.

### 2.7.4 Supervision et détection des défaillances

La supervision de l'architecture HD repose sur un système de **vérification croisée entre trois sites** :

**Sur les sites de concentration (actif et passif) :**
- Surveillance des ressources locales (SGBD, services de collecte, d'échange, d'alarme)
- Surveillance mutuelle des services de supervision (principe du quorum)

**Sur le site de surveillance :**
- Surveillance exclusive des services de supervision des sites de concentration
- Affinage des diagnostics en cas de défaillance détectée

La surveillance est réalisée au moyen de trames TCP envoyées sur des ports réseau, permettant de détecter :

- L'indisponibilité d'un site complet
- La défaillance d'un service spécifique
- Les problèmes d'accès réseau (LAN, VPN)
- L'indisponibilité du serveur d'appel vocal

En cas de dysfonctionnement, des alarmes téléphoniques sont automatiquement émises vers l'opérateur d'astreinte qui peut décider d'activer le basculement vers le site passif.

### 2.7.5 Positionnement dans le système d'information

L'architecture multi-sites s'appuie sur deux réseaux de communication redondants :

- **Réseau privé de collecte** : pour les échanges avec les stations hydrométriques
- **Réseau ministériel (RIE)** : pour les échanges avec les systèmes aval et la diffusion des données

Une solution de routage dynamique mise en œuvre sur les pare-feu permet aux instances AQUAREEL de disposer en permanence de deux chemins réseau pour communiquer entre elles, palliant ainsi l'indisponibilité de l'un d'entre eux.

## 2.8 Intégration dans le système d'information

### 2.8.1 Segmentation réseau et sécurité

Pour des raisons de sécurité, les composants AQUAREEL sont répartis dans deux zones distinctes, séparées par un pare-feu :

**Zone de collecte (réseau privé de collecte) :**
- Serveur de gestion de base de données (SGBD)
- Services de collecte et d'alarme
- Frontal IP
- Périphériques (modems RTC et radio)

**Zone métier (réseau ministériel RIE) :**
- Services échange et Internet
- Accès aux partages CIFS et serveurs FTP pour imports/exports
- Accès à Internet via le RIE pour envoi SMS et collecte LoRaWAN

Le pare-feu contrôle les flux entre ces zones et vers l'extérieur, assurant ainsi l'isolation du réseau de collecte vis-à-vis du réseau ministériel et d'Internet.

### 2.8.2 Diffusion des données

La fonction d'export permet de diffuser sur des partages (CIFS Windows ou FTP) locaux ou distants :

- Fichiers de mesures pour alimenter la base nationale PHyC en temps réel
- Fichiers pour sites internet des SPC
- Flux vers applications locales métier

Les exports peuvent être déclenchés automatiquement (fin de collecte, planification) ou manuellement par l'utilisateur. Plusieurs formats de fichiers sont supportés selon les besoins des systèmes aval.

## 2.9 Environnement de développement et métriques du code

### 2.9.1 Technologies et outils de développement

L'environnement de développement repose sur l'écosystème Microsoft et des technologies éprouvées :

**Modules applicatifs :**
- Langage : C#
- Frameworks : .NET 4.7.2 et .NET 8
- IDE : Visual Studio 2022
- Librairies : WPFToolkit (Mars 2009), Jquery, Bootstrap, Datatable, AdminLTE

**Base de données :**
- SGBD : SQL Server 2016 SP2
- Langage : Transact-SQL
- Outil de modélisation : PowerAMC 10 (MERISE pour le modèle relationnel, UML pour les modules)

**Développements orientés objets :**
Utilisation de patrons de conception reconnus (Factory, Singleton, DAO, DTO, Data Binding) favorisant la maintenabilité et l'évolutivité du code.

### 2.9.2 Métriques de la base de données

**Structure :**
- 150 tables réparties en 11 schémas
- Volume : ~15 Go/an pour 200 stations (l'essentiel sur 6 tables principales)

**Développements T-SQL (~10 000 lignes de code) :**
- 200 procédures stockées
- 100 vues
- 20 triggers
- 50 jobs de planification (majoritairement créés automatiquement)
- 1 publication de réplication

### 2.9.3 Métriques des modules applicatifs

La solution comporte 8 modules principaux et 2 sous-modules :

| Module | Fichiers | Lignes de code | Classes |
|--------|----------|----------------|---------|
| Client Windows | 1344 | 269 477 | 1703 |
| Client Web | 1049 | 220 003 | 1361 |
| Service de collecte | 832 | 228 963 | 1340 |
| Service d'import/export | 815 | 207 829 | 1194 |
| Service d'alarme | 1050 | 95 925 | 1180 |
| API Web | 943 | 64 832 | 959 |
| Service Internet | 1033 | 81 054 | 1106 |
| Frontal IP | 194 | 11 260 | 203 |
| Gestionnaire de bascule | 2 | 1 500 | 2 |

Cette volumétrie témoigne de la maturité et de la richesse fonctionnelle de l'application AQUAREEL.

## 2.10 Documentation existante

La documentation technique et fonctionnelle fournie par la maîtrise d'ouvrage comprend :

- Manuel d'exploitation
- Manuel utilisateur
- Manuel d'installation
- Modèle de données

Cette documentation sera maintenue et mise à jour systématiquement à chaque évolution ou correction apportée à l'application, contribuant ainsi à la pérennité de la connaissance applicative.

## 2.11 Synthèse et enjeux identifiés

L'architecture AQUAREEL se caractérise par :

**Points forts identifiés :**

- **Centralisation de la logique métier en base de données** : utilisation optimale des fonctions natives du SGBD SQL Server (procédures stockées, triggers, planificateur, réplication, Filestream)
- **Architecture multi-sites éprouvée** : haute disponibilité assurée par réplication transactionnelle et mécanismes de résilience automatique
- **Optimisation du stockage** : stratégies de non-stockage des données calculées et des zéros pluviométriques, purges automatisées
- **Diversité des médias de collecte** : radio, RTC/GSM, IP, LoRaWAN, import de fichiers
- **Traçabilité exhaustive** : journal de bord centralisé, système d'alarmes hydrologiques et techniques
- **Segmentation réseau sécurisée** : séparation zone de collecte / zone métier
- **Supervision multi-sites** : détection automatique des défaillances avec transmission d'alarmes

**Enjeux de maintenance identifiés :**

- **Migration vers le client léger** : accompagner l'abandon progressif du client Windows tout en préservant la continuité de service
- **Maîtrise de la volumétrie** : veiller au maintien des performances malgré l'accumulation continue de données (250 stations × 3 capteurs × 1 mesure/5 min)
- **Respect de la configuration matérielle** : optimiser les développements pour contribuer au maintien des performances dans la configuration serveur existante (2×8 cœurs, 16 Go RAM)
- **Résorption de la dette technique** : poursuivre les efforts engagés lors des précédents marchés
- **Évolutivité des réseaux de communication** : adapter la collecte aux nouveaux réseaux radio et satellites IoT
- **Compatibilité avec la réplication SQL Server** : toute évolution doit être compatible avec les mécanismes de haute disponibilité

Le titulaire a pris la mesure de ces enjeux et s'engage à intervenir dans le strict respect de l'architecture existante, en préservant sa fiabilité, sa stabilité et ses performances éprouvées dans le cadre opérationnel des Services de Prévisions des Crues.

En complément, nous identifions quatre points de vigilance prioritaires pour la TMA :
- **Volumétrie et performances SQL Server** : nous prévoyons des revues régulières de performances (plans d'exécution, indexation, statistiques) sur les tables les plus volumineuses, en nous appuyant sur des jeux de données de référence ;
- **Réplication transactionnelle et haute disponibilité** : chaque évolution impactant la base fait l'objet d'une analyse d'impact sur la réplication et de tests spécifiques sur la chaîne active/passive ;
- **Migration progressive vers le client léger** : nous veillons à la compatibilité ascendante des évolutions côté base et services, en particulier sur les interfaces partagées entre client lourd et client léger ;
- **Dette technique SQL et applicative** : les éléments identifiés sont inscrits dans un backlog dédié, priorisé avec la maîtrise d'ouvrage et traités par lots, afin de réduire progressivement les zones de fragilité sans perturber l'exploitation.

---

**Conclusion du chapitre 02**

Cette analyse de l'architecture AQUAREEL démontre notre compréhension approfondie de l'application, de ses principes structurants et de ses enjeux techniques. Nous nous engageons à conduire les opérations de maintenance en préservant rigoureusement cette architecture éprouvée, contribuant à la fiabilité et à la continuité de service attendues pour une application critique de sécurité civile.
