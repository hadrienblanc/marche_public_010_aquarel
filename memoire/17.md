# Annexe D — Exemples concrets (runbooks, supervision, tests)

Cette annexe fournit des **exemples concrets** (extraits) pour faciliter l'évaluation par le jury : continuité opérationnelle, contrôles de supervision recommandés, et automatisation de tests de non‑régression. Les exemples s'adaptent à l'outillage retenu par le SCV.

---

## D.1 Extrait de runbook “dossier d'urgence” (structure + checklists)

### D.1.1 Contacts & accès (exemple de structure)
- SCV : `[nom]` — `[email]` — `[téléphone]`
- SPC GD : `[nom]` — `[email]` — `[téléphone]`
- Titulaire (interlocuteur unique) : `contact@hadrienblanc.com` — `07 83 77 52 44`
- Renforts pré‑positionnés : cf. Annexe C

**Accès**
- VPN : OpenVPN (fourni par le SCV) — comptes nominatifs — traçabilité.
- Environnements : `DEV` / `TEST` (titulaire) ; `PROD` (SCV/services utilisateurs) selon habilitation.

### D.1.2 Checklist “Réplication / HD en alerte” (exemple)
1. Ouvrir un ticket “urgence” et horodater (début, diagnostic, rétablissement).
2. Constater le symptôme : alarme supervision, dérive latence, erreurs réplication, désynchronisation.
3. Qualifier la cause : applicatif vs environnement (réseaux / capteurs / OS / supervision).
4. Vérifier l'état des jobs/agents SQL Server (échecs, backlog, erreurs).
5. Vérifier l'état des services AQUAREEL liés (collecte, échanges, supervision).
6. Proposer une action sécurisée : contournement provisoire / correction définitive / demande bon de commande si nécessaire.
7. Mettre à jour le ticket + produire le rapport d'intervention (Annexe A.3) + enrichir tests NR si applicable (Annexe A.2).

### D.1.3 Checklist “Espace disque faible / croissance base” (exemple)
1. Confirmer l'alerte (volume concerné, seuil atteint).
2. Vérifier les purges/archivages paramétrés (base tampon / base prod / logs).
3. Identifier la cause : logs applicatifs, rétention, job en échec, flux anormal.
4. Proposer un plan d'action : purge/archivage conforme, correction du job, recommandation audit, besoin d'intervention ponctuelle.
5. Tracer : ticket + décision + action + preuve.

---

## D.2 Extrait de synthèse “contrôles de supervision” (exemple de restitution)

> Objectif : fournir une synthèse exploitable **sans imposer** un outil (pas de promesse de monitoring 24/7).

**Objet email (exemple)** : `[AQUAREEL] Contrôles supervision – [instance/site] – [JJ/MM/AAAA]`

**Synthèse**
- Réplication : `[OK/KO]` — latence ordre de grandeur : `[valeur]` — erreurs : `[oui/non]`
- Jobs planifiés : `[OK/KO]` — échecs : `[N]` (références : `[ids]`)
- Espace disque : `[OK/KO]` — volume libre : `[valeur]` — alerte si < seuil convenu
- Services AQUAREEL : `[OK/KO]` — services arrêtés : `[liste]`
- Logs applicatifs : `[OK/KO]` — erreurs notables : `[liste courte]`

**Actions / décisions**
- `[action 1]` — responsable : `[SCV/MOE/titulaire]` — échéance : `[JJ/MM]` — ticket : `[ID]`
- `[action 2]` — responsable : `[SCV/MOE/titulaire]` — échéance : `[JJ/MM]` — ticket : `[ID]`

---

## D.3 Exemple de cas de test SQL non‑régression (Arrange / Act / Assert)

> Principe : un jeu de données de référence est restauré, puis le test prépare un cas minimal, exécute la logique, et vérifie des **invariants**.

```sql
-- T-NR-EX-001 : invariant "pas de doublon" après traitement
-- Arrange
BEGIN TRAN;
-- préparation de données minimales (exemples génériques)
INSERT INTO dbo.Exemple_Entite (Id, Valeur) VALUES (1001, 'A');

-- Act
EXEC dbo.usp_Traitement_Exemple @Id = 1001;

-- Assert
IF EXISTS (
  SELECT 1
  FROM dbo.Exemple_Entite
  WHERE Id = 1001
  GROUP BY Id
  HAVING COUNT(*) > 1
)
  THROW 50000, 'Non‑régression KO : doublon détecté', 1;

ROLLBACK;
```

**Résultat attendu**
- le test est **rejouable** (transaction/rollback) ;
- l'assertion porte sur un invariant métier/technique (doublon, intégrité, comptage, état d'un job, etc.) ;
- le cas de test est tracé dans le rapport de non‑régression (Annexe A.2).

---

## D.4 Extrait “réponse à incident” (cyber / corruption) — sans sur‑promesse

### D.4.1 Exemple : suspicion de ransomware (mesures conservatoires)
1. Alerter les référents SCV/services utilisateurs selon la procédure en place.
2. Préserver les preuves (logs) et **éviter toute action destructrice** sans instruction.
3. Vérifier l'impact : services, accès, intégrité, capacité à opérer en mode dégradé.
4. Proposer un plan de reprise compatible avec les responsabilités (SPC/SCV hors heures ouvrées ; titulaire en heures ouvrées), et tracer la décision.

### D.4.2 Exemple : suspicion de corruption SQL Server
1. Qualifier le périmètre (base tampon / prod / archive ; réplication ; services impactés).
2. Proposer une analyse d'intégrité et une stratégie de restauration **validée par la maîtrise d'ouvrage**.
3. Tracer : ticket + rapport d'intervention (Annexe A.3) + RCA si nécessaire (Annexe A.5) + tests NR ajoutés.

