# 9. Assurance qualité et tests

> **Lecture jury — à retenir**
> - Objectif : garantir la non‑régression (base + applicatif + HD), avant toute livraison et avant VA/VSR.
> - Risques évités : régression en production, dette technique non maîtrisée, dérive de performance (baseline).
> - Réponse du titulaire : tests SQL automatisés, quality gate, rapport de tests, critères d'entrée/sortie de recette.
> - Preuves : Annexe A.2 (rapport tests), Annexe A.10 (recette), Annexe A.1 (livraison), Annexe D (exemples).

## 9.1 Démarche qualité globale

La maintenance d'une application critique de sécurité civile comme AQUAREEL impose une rigueur élevée dans les processus de développement, de validation et de mise en production. Notre démarche qualité s'inscrit dans le respect strict des exigences du CCTP et vise à assurer la stabilité opérationnelle du concentrateur de mesures hydrométriques.

### 9.1.1 Principes fondamentaux

Notre approche qualité repose sur quatre piliers :

**Non-régression systématique**
Toute modification du code existant, qu'il s'agisse de maintenance évolutive ou corrective, doit préserver l'intégralité des fonctionnalités opérationnelles. La haute disponibilité, la réplication SQL Server et les collectes en temps réel constituent des points de contrôle critiques à vérifier systématiquement.

**Traçabilité complète**
Chaque anomalie, chaque test, chaque livraison fait l'objet d'un enregistrement dans la plateforme de suivi. La traçabilité permet d'établir un historique des évolutions et de répondre aux exigences d'audit du maître d'ouvrage.

**Validation progressive**
Les tests unitaires, d'intégration et de validation précèdent les phases de recette (VA et VSR). Cette progression méthodique vise à assurer la qualité des livrables avant présentation au maître d'ouvrage.

**Documentation synchronisée**
Tout développement ou correction s'accompagne de la mise à jour de la documentation technique (manuel d'exploitation, manuel utilisateur, modèle de données). La documentation reflète en permanence l'état réel du système.

### 9.1.2 Organisation de l'assurance qualité

Le titulaire assure la fonction qualité : il vérifie l'application des procédures et veille au respect des standards de développement définis dans le CCTP :
- Utilisation des fonctions natives du SGBD (procédures stockées, triggers, planification)
- Respect des normes de développement SQL (limitation des curseurs et fonctions scalaires)
- Conformité aux patrons de conception existants (Factory, Singleton, DAO, DTO)
- Validation des évolutions du modèle de données selon la méthode MERISE

## 9.2 Stratégie de tests

### 9.2.1 Tests unitaires

Les tests unitaires couvrent chaque composant modifié ou développé :

**Tests des procédures stockées T-SQL**
- Validation des paramètres d'entrée et des retours
- Contrôle des cas limites et des valeurs nulles
- Vérification des performances (temps d'exécution sur jeux de données représentatifs)
- Validation de la gestion des transactions et des contraintes d'intégrité

**Tests des services C#**
- Tests des modules de collecte (Radio, RTC, IP, LoRaWAN)
- Tests des services d'échange (imports/exports)
- Tests du service d'alarme et de supervision
- Validation des traitements batch et temps réel

**Tests du client web et du client Windows**
- Validation des IHM et des contrôles utilisateur
- Tests de connectivité à la base de données de production
- Vérification des droits d'accès et de l'authentification

#### 9.2.1.1 Automatisation des tests SQL (procédures, triggers, jobs)

Afin d'industrialiser les validations sur un socle fortement centré SGBD, le titulaire met en place une exécution automatisée des tests SQL, basée sur :
- une **base de test isolée** (dédiée), réinitialisée de manière reproductible à partir d'un schéma de référence et d'un jeu de données de référence ;
- des scripts de tests structurés en **Arrange / Act / Assert** : préparation des données, exécution de la procédure/trigger/job, puis assertions sur les résultats (jeux de résultats, tables impactées, intégrité, effets de bord) ;
- des contrôles adaptés aux contraintes AQUAREEL (volumétrie, réplication, triggers) : comparaisons d'ensembles, comptages, contrôles d'invariants, et vérifications ciblées de performance ;
- une exécution automatisée (scripts SQL + orchestration) produisant des résultats traçables et exportables.

Ces tests sont conçus pour être **rejouables** et **maintenables** : ils enrichissent progressivement la batterie de non‑régression, et alimentent le rapport de tests transmis avec chaque livraison.

Exemple de cas de test (Arrange/Act/Assert) : cf. **Annexe D**.

### 9.2.2 Tests d'intégration

Les tests d'intégration vérifient le bon fonctionnement des composants assemblés :

**Intégration base de données – services**
- Vérification des flux de données entre la base tampon, la base de production et les services
- Validation du processus d'affinage des données collectées
- Tests de la réplication SQL Server (publication, abonnés)

**Intégration avec les périphériques**
- Tests avec les stations d'acquisition (LNS, AQUACJ)
- Validation des collectes via modems radio, RTC et 3G
- Tests du frontal IP et des collectes LoRaWAN
- Vérification des échanges via serveur MOXA et Speech Unit

**Intégration des clients**
- Tests d'accès distant sécurisé (OpenVPN)
- Validation des fonctionnalités multi-utilisateurs
- Vérification de la cohérence des données affichées entre client lourd et client léger

### 9.2.3 Tests de non-régression

La constitution et l'enrichissement continu d'une batterie de tests de non-régression contribue à la stabilité du système. Avant chaque livraison, une campagne de tests de non‑régression, automatisée (base + applicatif) sur un jeu de données de référence et complétée si nécessaire par des contrôles manuels ciblés, est exécutée et fait l'objet d'un rapport de tests transmis à la maîtrise d'ouvrage :

**Scénarios de régression fonctionnelle**
- Validation des fonctionnalités de collecte automatique et manuelle
- Vérification des calculs hydrologiques (débits, cumuls pluviométriques, gradients)
- Tests des exports et de la diffusion de données (CIFS, FTP)
- Contrôle des alarmes hydrologiques et fonctionnelles
- Tests du journal de bord et de la supervision

**Scénarios de régression technique**
- Validation de la purge et de l'archivage des données
- Tests de la maintenance automatisée de la base de données
- Vérification des jobs de planification SQL Server
- Tests de montée en charge (collecte simultanée de 250 stations avec 3 capteurs chacune)

**Tests de haute disponibilité**
Point critique pour une application de sécurité civile, les tests de non-régression sur la HD incluent systématiquement :
- Validation de la réplication SQL Server transactionnelle entre site actif et sites passifs
- Tests de basculement automatique des tâches de concentration en cas d'échec du site actif
- Vérification du gestionnaire de bascule (désactivation/activation des tâches, suppression de la réplication)
- Contrôle de la supervision inter-sites (quorum entre les 3 services d'alarme/supervision)
- Tests de secours des collectes (radio, IP, LoRaWAN) et des échanges depuis le site passif

### 9.2.4 Tests de performance

Les tests de performance vérifient le maintien des capacités de traitement du système :
- Temps de réponse des requêtes SQL complexes
- Durée d'exécution des procédures d'affinage et de calcul
- Latence de réplication entre sites actif et passif
- Temps de traitement des collectes automatiques (250 stations, 3 capteurs, mesure toutes les 5 minutes)
- Performance du client web et du client lourd en situation de charge nominale

**Baseline et suivi**
Les Questions/Réponses du DCE (08/12/2025) indiquent que les requêtes les plus volumineuses du client léger ne dépassent pas actuellement ~3 secondes. Le titulaire utilise cette information comme baseline de départ : les temps de réponse sont mesurés sur la plateforme de test et les écarts significatifs (dégradation) sont analysés, documentés et, le cas échéant, corrigés (indexation, réécriture, ajustements ciblés).

## 9.3 Plateforme de test et environnements

### 9.3.1 Plateforme de développement

Environnement dédié aux développements et tests unitaires :
- SQL Server 2016 SP2 Standard Edition
- Visual Studio 2022 pour les développements C# (.NET 4.7.2 / .NET 8)
- Serveur IIS 10 pour le client web
- Environnement virtualisé reproduisant l'architecture standard (serveur principal + serveur d'échange)

### 9.3.2 Plateforme de test

La plateforme de test reproduit un fonctionnement d'ensemble en configuration haute disponibilité :
- 2 sites de concentration (actif et passif) avec réplication SQL Server
- 1 site de surveillance
- 2 stations d'acquisition (LNS et AQUACJ) fournies par le maître d'ouvrage
- Modem 3G pour tests de collecte
- Périphériques radio et RTC (serveur de terminaux MOXA)
- Accès distant sécurisé OpenVPN vers le réseau privé de collecte

Cette plateforme permet de valider en conditions réelles :
- La collecte sur tous les médias (radio, RTC, IP, LoRaWAN)
- Le fonctionnement de la haute disponibilité (réplication, bascule, supervision)
- Les exports et imports de données
- La transmission d'alarmes (mail, téléphone, SMS via opérateurs externes)

### 9.3.3 Plateforme de test radio à Privas

Pour les tests spécifiques nécessitant le réseau radio SCORPION 2, la plateforme du SPC Grand Delta à Privas (07) est accessible à distance. Cette plateforme permet de valider les développements en environnement réel avec collecte radio opérationnelle.

## 9.4 Processus de validation et recette

### 9.4.1 Tests internes avant livraison

Avant toute livraison au maître d'ouvrage, nous réalisons une validation interne complète :

**Phase de réalisation (Étape 3)**
- Exécution de la batterie de tests unitaires et d'intégration
- Tests de non-régression sur plateforme de développement
- Tests d'intégration sur plateforme de test en configuration HD
- Validation avec les périphériques réels (stations, modems)
- Le cas échéant, tests sur la plateforme radio de Privas

**Cahier de recette**
Nous rédigeons un cahier de recette détaillé pour chaque lot d'évolutions ou de corrections (cf. Annexe A.10). Ce document :
- Liste l'ensemble des cas de tests à exécuter
- Précise les données d'entrée et les résultats attendus
- Identifie les points de contrôle critiques (HD, réplication, collectes)
- Sert de support pour nos tests internes et pour la recette du maître d'ouvrage

**Recette "usine"**
Pour les lots d'évolutions importants, une recette usine peut être réalisée à distance ou dans un environnement dédié convenu avec la maîtrise d'ouvrage avant passage en VA. Cette revue d'une journée maximum permet de constater le bon fonctionnement global avant livraison formelle.

#### 9.4.1.1 Critères de sortie (Quality Gate)

Avant de transmettre une livraison, le titulaire applique un contrôle de sortie standardisé. Ce contrôle constitue un quality gate : une livraison n'est pas transmise comme « prête à déployer » si un des éléments ci‑dessous est manquant :
- ticket à jour (contexte, périmètre, décisions, liens vers livrables) ;
- code et scripts versionnés ; note de livraison prête (cf. Annexe A.1) ;
- scripts SQL de mise à jour + procédure d'installation + procédure de rollback ;
- campagne de tests exécutée (unitaires, intégration, non‑régression, HD si applicable) ;
- rapport de tests de non‑régression joint (résultats + points de vigilance) (cf. Annexe A.2) ;
- documentation impactée mise à jour (si applicable).

### 9.4.2 Vérification d'Aptitude (VA)

La VA est réalisée par le SPC Grand Delta dans ses locaux, sur ses plateformes de test et d'intégration.

**Objectifs de la VA**
- Vérifier la conformité du logiciel au dossier de spécifications détaillées
- Contrôler la complétude et l'exactitude de la documentation mise à jour
- Valider l'aptitude du logiciel à remplir les fonctions attendues

**Types de tests en VA**
- Tests fonctionnels (conformité aux spécifications)
- Tests d'accès distant (OpenVPN)
- Tests de performance (temps de réponse, volumétrie)
- Tests de non-régression (notamment haute disponibilité)

**Critères de validation**
La VA est validée en l'absence d'anomalie bloquante ou majeure. Les anomalies sont qualifiées selon la grille suivante :
- **Bloquante** : empêche l'utilisation de l'application (absence de collecte, absence d'alimentation de la base nationale PHyC)
- **Majeure** : certaines fonctions importantes ne sont plus accessibles (gestion des alarmes inopérante)
- **Mineure** : l'application fonctionne malgré l'impact sur une fonction mineure

**Traitement des anomalies**
- **Anomalies bloquantes** : transmises immédiatement, délai d'intervention de 2 jours ouvrés
- **Anomalies majeures** : délai d'intervention de 2 jours ouvrés
- **Anomalies mineures** : regroupées pour livraison groupée, délai maximum d'un mois

À l'issue de la VA, le maître d'ouvrage notifie sa décision :
- Réception : les prestations répondent aux stipulations
- Ajournement : mises au point nécessaires (sans surcoût)
- Réfaction : réception avec réduction de prix proportionnelle aux imperfections
- Rejet : non-conformité, refus de réception

Conformément au CCAP, l'admission est conclue par un **procès-verbal de recette** (PV) établi par le représentant de la personne publique et notifié au titulaire. Les décisions sont notifiées par **courriers électroniques** et chaque partie accuse réception des échanges.

### 9.4.3 Vérification de Service Régulier (VSR)

La VSR valide le fonctionnement en conditions opérationnelles réelles.

**Objectifs de la VSR**
- Constater que le logiciel assure un service régulier en conditions normales de production
- Vérifier l'adéquation de la documentation technique avec les besoins opérationnels

**Déroulement de la VSR**
- Mise en œuvre par le Service Central Vigicrues et des SPC testeurs
- Fonctionnement en mode opérationnel pendant une durée minimale d'un mois continu
- Tests en conditions réelles de collecte, diffusion et supervision

**Critères de validation**
Le service est réputé régulier si l'application fonctionne de manière continue pendant un mois minimum sans anomalie bloquante ni majeure.

**Intervention pendant la VSR**
Nous nous engageons à intervenir dans un délai maximal de 2 jours ouvrés pour chaque anomalie bloquante identifiée. Pour les anomalies non bloquantes et mineures, le délai de résolution est établi en concertation avec le maître d'ouvrage.

La VSR porte autant sur la conformité des prestations réalisées que sur la vérification de l'absence de régression de l'application existante.

À l'issue de la VSR, la décision d'admission est formalisée par un **PV**, dans les mêmes conditions de notification (email + accusé de réception).

## 9.5 Gestion des anomalies

### 9.5.1 Plateforme de suivi

Nous mettons en place et maintenons une plateforme de gestion des anomalies et des demandes d'intervention. Cette plateforme assure :
- Déclaration et suivi en temps réel des anomalies
- Traçabilité complète des interventions (diagnostic, solution, tests)
- Qualification des anomalies (bloquante, majeure, mineure)
- Historique des corrections et des versions livrées
- Accès en ligne pour les gestionnaires des SPC avec identifiants dédiés

### 9.5.2 Processus de traitement

**Réception et qualification**
- Réception de l'anomalie avec description, données et étapes de reproduction
- Qualification initiale (bloquante, majeure, mineure)
- Reproduction sur plateforme de test
- Diagnostic technique et identification de la cause

**Développement et tests**
- Correction sur environnement de développement
- Tests unitaires et d'intégration
- Tests de non-régression complets
- Validation interne avant livraison

**Livraison et validation**
- Livraison "de mise à jour" comprenant :
  - Document de traçabilité des modifications
  - Rapport de tests de non‑régression (synthèse de la campagne exécutée, résultats et points de vigilance)
  - Setup d'installation de la mise à jour
  - Procédure d'installation
  - Documentation impactée mise à jour
  - Mise à jour du code source
- Validation par le maître d'ouvrage selon les délais définis

### 9.5.3 Traçabilité et reporting

Un rapport mensuel de synthèse est transmis au Service Central Vigicrues et au SPC Grand Delta comprenant :
- État des anomalies en cours de traitement
- Anomalies clôturées avec référence aux correctifs livrés
- Consommation du forfait support
- Indicateurs de qualité (délais d'intervention, taux de résolution)

## 9.6 Gestion de configuration et des versions

### 9.6.1 Gestion du code source

**Système de gestion de versions**
Utilisation d'un système de gestion de versions centralisé (Git) pour :
- Traçabilité complète de l'historique des modifications
- Branches dédiées par lot d'évolutions ou correctifs
- Gestion des conflits entre développements concurrents
- Intégration contrôlée des modifications validées

**Nomenclature des versions**
Chaque livraison est identifiée par un numéro de version selon le schéma : MAJEUR.MINEUR.CORRECTIF
- MAJEUR : évolutions fonctionnelles importantes
- MINEUR : évolutions mineures ou corrections multiples
- CORRECTIF : correctif unitaire

**Archivage des versions**
Conservation de toutes les versions livrées avec leur code source complet, permettant la traçabilité et la possibilité de reconstituer toute version historique.

### 9.6.2 Documentation des livrables

**Livraison complète** (maintenance évolutive)
- Document de traçabilité des modifications par rapport à la version de référence
- Rapport de tests de non‑régression (synthèse de la campagne exécutée, résultats et points de vigilance)
- Setup d'installation de l'application (tous composants)
- Code source complet de l'application
- Procédure d'installation détaillée
- Documentation complète mise à jour (manuel exploitation, manuel utilisateur, modèle données)

**Livraison "de mise à jour"** (maintenance corrective)
- Document de traçabilité des modifications
- Rapport de tests de non‑régression (synthèse de la campagne exécutée, résultats et points de vigilance)
- Setup d'installation de la mise à jour
- Procédure d'installation de la mise à jour
- Documentation impactée mise à jour
- Mise à jour du code source des composants concernés

### 9.6.3 Traçabilité des modifications

Un registre des modifications est maintenu pour chaque livraison, détaillant :
- Nature des modifications (évolution fonctionnelle, correction, optimisation)
- Composants impactés (base de données, services, clients)
- Scripts SQL d'évolution du schéma de données
- Impact sur la configuration matérielle et logicielle
- Tests réalisés et résultats obtenus
- Points de vigilance pour l'installation et l'exploitation

## 9.7 Revue de code et standards

### 9.7.1 Revue de code pour les développements en base

**Validation au fil de l'eau**
Conformément aux exigences du CCTP, les développements réalisés en base de données sont validés "au fil de l'eau" par le maître d'ouvrage. Cette validation porte sur :
- Respect des normes de nommage (domaines, entités, tables, vues, procédures)
- Interdiction de réutilisation des identifiants SQL (sauf clés étrangères)
- Limitation des curseurs et des fonctions scalaires (UDF)
- Optimisation des requêtes pour gérer la volumétrie (15 Go/an pour 200 stations)
- Utilisation préférentielle des procédures stockées et vues pour les opérations DML

**Évolution du modèle de données**
Toute évolution du modèle conceptuel fait l'objet :
- D'une modélisation MERISE conforme aux normes initiales
- D'une validation préalable par le maître d'ouvrage avant application
- D'une mise à jour du modèle de données documenté (PowerAMC)

### 9.7.2 Revue de code pour les services

**Cohérence avec l'existant**
Les développements des services C# respectent :
- Normes et conventions de nommage du projet initial
- Patrons de conception existants (Factory, Singleton, DAO, DTO, Data Binding)
- Modularité et découpage en couches (8 modules + 2 sous-modules)
- Structure du code source existante

**Standards de qualité**
- Documentation des classes et méthodes publiques
- Gestion des exceptions et des logs
- Tests unitaires systématiques
- Optimisation des performances (limitation des allocations mémoire, utilisation du pool de connexions SQL)

### 9.7.3 Contrôle qualité avant livraison

Avant toute livraison, une revue qualité systématique vérifie :
- Absence de code commenté ou de traces de débogage
- Cohérence des logs et des messages d'erreur
- Validation des paramètres d'entrée et protection contre les injections SQL
- Conformité aux bonnes pratiques de développement .NET et T-SQL
- Complétude de la documentation technique

## 9.8 Tests spécifiques à la haute disponibilité

La configuration HD étant celle recommandée par le maître d'ouvrage, toute modification fait l'objet de tests spécifiques approfondis :

### 9.8.1 Tests de réplication SQL Server

- Validation de la publication et des abonnés après modifications du schéma
- Contrôle de la latence de réplication (temps de propagation des modifications)
- Tests de réinitialisation de la réplication (scripts et procédures)
- Vérification de la cohérence des données entre site actif et sites passifs
- Tests de la surveillance de la réplication depuis le client Windows

### 9.8.2 Tests de basculement

- Basculement manuel vers le site passif via le gestionnaire de bascule
- Vérification de la désactivation des tâches sur le site actif
- Contrôle de l'activation des tâches sur le nouveau site actif
- Test de la suppression de la réplication depuis l'ancien site actif
- Validation du retour à la normale (bascule inverse)

### 9.8.3 Tests de secours automatique

- Simulation d'indisponibilité du frontal IP sur le site actif
- Validation de la collecte IP automatique sur le site passif
- Tests de secours des collectes LoRaWAN
- Validation du secours des échanges (imports/exports)
- Tests de basculement de la collecte radio

### 9.8.4 Tests de supervision inter-sites

- Validation de la surveillance croisée entre les 3 services de supervision
- Simulation d'indisponibilité d'un site (actif, passif, surveillance)
- Tests de détection d'indisponibilité des services (SGBD, collecte, échange, alarme)
- Validation des alarmes téléphoniques vers l'opérateur d'astreinte
- Vérification du quorum de supervision (principe de cluster)

## 9.9 Garantie et amélioration continue

### 9.9.1 Garantie d'un an

Toute prestation de maintenance évolutive ou corrective bénéficie d'une garantie d'un an à compter de sa réception. Pendant cette période, nous nous engageons à corriger gratuitement les anomalies liées aux développements effectués, selon les délais applicables à la maintenance corrective.

### 9.9.2 Amélioration continue

Notre démarche qualité intègre un processus d'amélioration continue :

**Retour d'expérience**
- Analyse des anomalies récurrentes pour identification des causes racines
- Enrichissement de la batterie de tests de non-régression
- Mise à jour des procédures et standards de développement

**Métriques qualité**
- Taux de détection des anomalies en phase interne vs phase VA/VSR
- Délais moyens d'intervention et de résolution
- Nombre d'anomalies par type (bloquante, majeure, mineure)
- Taux de réussite de la VA et de la VSR au premier passage

**Audit annuel**
Les audits périodiques commandés par les services utilisateurs contribuent à l'amélioration continue en identifiant :
- Dysfonctionnements non détectés par la supervision automatisée
- Opportunités d'optimisation de la configuration et de la maintenance
- Points d'attention pour les prochaines évolutions

## 9.10 Synthèse des engagements qualité

Notre démarche d'assurance qualité vise à assurer :

1. **Stabilité opérationnelle** : tests de non-régression systématiques avant toute livraison, avec vigilance particulière sur la haute disponibilité et la réplication SQL Server

2. **Traçabilité complète** : plateforme de suivi des anomalies et des interventions, gestion de versions rigoureuse, documentation synchronisée

3. **Validation progressive** : tests unitaires, tests d'intégration, tests de validation interne avant recette (VA et VSR)

4. **Conformité aux standards** : respect des normes de développement du CCTP (utilisation des fonctions SGBD, optimisation SQL, patrons de conception)

5. **Respect des délais** : intervention sous 2 jours ouvrés pour les anomalies bloquantes, traitement méthodique des anomalies mineures

6. **Documentation à jour** : maintien en permanence de la documentation technique en cohérence avec l'état du système

7. **Amélioration continue** : retour d'expérience, métriques qualité, enrichissement des tests

Cette rigueur méthodologique, adaptée au caractère critique de l'application AQUAREEL et aux contraintes opérationnelles des Services de Prévision des Crues, contribue à la continuité de service et à la fiabilité attendues pour une mission de sécurité civile.
